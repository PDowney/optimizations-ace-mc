# AI-Powered Security Vulnerability Scanner
# Scans all committed changes for security vulnerabilities using Gemini AI
# Focuses on WordPress-specific security issues: SQL injection, XSS, CSRF, etc.

name: Gemini Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

# Cancel previous workflow runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: read

jobs:
  security-scan:
    name: AI Security Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v46
        with:
          files: |
            **/*.php
            **/*.js
            **/*.sql
          separator: "\n"

      - name: Run Gemini Security Analysis
        if: steps.changed-files.outputs.any_changed == 'true'
        env:
          CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          npx @google/gemini-cli@latest --prompt "
          You are a WordPress security expert with deep knowledge of plugin vulnerabilities.
          
          SECURITY SCAN INSTRUCTIONS:
          Analyze the following code changes for security vulnerabilities. Focus on:
          
          üî¥ CRITICAL SECURITY ISSUES:
          - SQL Injection: Check for unsanitized database queries, missing prepared statements
          - Cross-Site Scripting (XSS): Look for unescaped output, missing esc_html/esc_attr
          - Cross-Site Request Forgery (CSRF): Verify nonce usage in forms and AJAX
          - Authentication Bypass: Check user capability validation
          - File Upload Vulnerabilities: Verify file type and size validation
          - Directory Traversal: Look for path manipulation vulnerabilities
          - Code Injection: Check for eval(), exec(), system() usage
          
          üü° WORDPRESS-SPECIFIC SECURITY:
          - Proper use of WordPress sanitization functions
          - Correct capability checks (current_user_can)
          - WordPress nonce verification
          - Proper use of wpdb prepared statements
          - Validation of user input and file uploads
          - Secure handling of options and meta data
          
          üü¢ BEST PRACTICES:
          - Input validation and sanitization
          - Output escaping and encoding
          - Secure API endpoint implementation
          - Proper error handling without information disclosure
          
          For each issue found:
          1. Specify the exact file and line number
          2. Explain the vulnerability type and risk level
          3. Provide secure code recommendations
          4. Reference WordPress Codex security guidelines
          
          If no vulnerabilities are found, confirm the code follows WordPress security standards.
          
          FILES TO ANALYZE:
          $CHANGED_FILES
          " > security-analysis.txt

      - name: Display Security Analysis Summary
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "=================================="
          echo "üîí SECURITY ANALYSIS REPORT"
          echo "=================================="
          echo "Repository: ${{ github.repository }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref }}"
          echo "Files Analyzed: ${{ steps.changed-files.outputs.all_changed_files }}"
          echo "Analysis Date: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          echo ""
          echo "ü§ñ AI Security Expert Findings:"
          echo "=================================="
          
          if [ -f "security-analysis.txt" ]; then
            cat security-analysis.txt
          else
            echo "‚ö†Ô∏è No analysis output found."
          fi
          
          echo ""
          echo "=================================="
          echo "üìã Next Steps:"
          echo "- Review any security issues identified above"
          echo "- Address critical and high-severity findings immediately"
          echo "- Test all security-related changes thoroughly"
          echo "- Consider implementing additional security measures if recommended"
          echo "=================================="

      - name: Create Workflow Summary
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: actions/github-script@v7
        env:
          CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
        with:
          script: |
            const fs = require('fs');
            const changedFiles = process.env.CHANGED_FILES;
            
            let analysisContent = 'No analysis output found.';
            try {
              if (fs.existsSync('security-analysis.txt')) {
                analysisContent = fs.readFileSync('security-analysis.txt', 'utf8');
              }
            } catch (error) {
              console.log('Error reading analysis file:', error);
              analysisContent = 'Error reading security analysis results.';
            }
            
            const summaryContent = `
            ## üõ°Ô∏è WordPress Security Analysis Results
            
            **Repository:** ${context.repo.owner}/${context.repo.repo}
            **Commit:** ${context.sha}
            **Branch:** ${context.ref}
            **Files Analyzed:** ${changedFiles}
            **Analysis Date:** ${new Date().toISOString()}
            
            ---
            
            ### ü§ñ AI Security Expert Findings
            
            ${analysisContent}
            
            ---
            
            ### üìã Next Steps
            - Review any security issues identified above
            - Address critical and high-severity findings immediately
            - Test all security-related changes thoroughly
            - Consider implementing additional security measures if recommended
            
            **Workflow Run:** ${context.payload.repository.html_url}/actions/runs/${context.runId}
            `;
            
            await core.summary
              .addHeading('üîí Security Analysis Report')
              .addRaw(summaryContent)
              .write();
            
            console.log('‚úÖ Security analysis summary created in workflow logs');


